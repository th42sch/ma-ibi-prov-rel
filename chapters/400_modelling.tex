% !TeX spellcheck = en_GB
% =================================================================
\chapter{Modelling Provenance Relationships}
\label{chap:modelling}

\todo[inline,color=red!30]{Give more explanation for people not familiar with graph theory; make steps that seem logical more explicit; name advantages of using graph theory as an instrument (modelling power, abstraction, available methods, well-behaved algorithms, ready-to-use implementations); span bridge from concrete example queries to GT; possibly give links to basic (video) tutorials in GT (ask Leif?)}
  
In this chapter, we develop a generic approach to modelling provenance relationships.
More precisely, we need to model three central notions: queries that a user may want to ask,
data sources that are to be consulted in order to answer a query,
and answers given to a query.
In order to obtain a generic approach, we aim at providing rigorous definitions
for these central concepts, and we seek intensional rather than extensional definitions.
In particular, those definitions should not depend on concrete example queries or data sources
such as the ones discussed in Chapters~\ref{chap:prototype_queries} and~\ref{chap:analysis};
neither should they depend on concrete objects, concepts, or relationships
(such as \enquote{Copernicus}, \enquote{exemplar}, or \enquote{student}).
Instead, we will develop an abstract model that formalises
the notions of a query, data source, and answer.
This model can then be instantiated with a multitude of concrete queries and data sources,
and it specifies how future implementations need to proceed in order to
provide answers as specified by the definitions in the model.

As a basis for our abstract model, we choose standard concepts and techniques
from graph theory.
The concept of a graph is widely used in computer science and discrete mathematics;
see standard textbooks \autocite[e.g.,][]{Diestel2012}.
Graphs and graph techniques are widely applied in various areas such as 
computer science, linguistics, physics and chemistry,
social sciences, and biology \autocite{WikiGraphTheoryApplications}.
In particular, they are used to represent large knowledge bases \autocite[e.g.,][]{Ehrlinger2016}
and underlie the Resource Description Framework (RDF) ..., which is a standard of the
World Wide Web Consortium (W3C) ... 
Furthermore, the basic definition of a graph is conceptually simple,
while graph theory provides a plethora of well-understood methods,
some of which lend themselves to computationally well-behaved algorithms for query answering. \todo{explain; citation}

\todo[inline,caption={}]{
  \parbox{.99\linewidth}{%
    Comment on restrictions made:
    %
    \begin{itemize}
      \item
        no temporal distinctions (\enquote{is/was student}) or \enquote{was owner in year $n$}. 
      \item[$(\leadsto)$]
        no attributes for relationships (citation)
      \item[$\leadsto$]
        keep the presentation digestible for readers with little or no background in maths and CS
        (i.e., a large proportion of librarians and historians).
      \item
        possible extensions in Section~\ref{sec:possible_extensions}
    \end{itemize}
  }%
}

In this chapter ...

\todo[inline]{Delineate from classical database theory (text snippets commented out)? Take care that this argument is a logical consequence of the requirement analysis in the previous chapter(s)!}

%An obvious choice would be to base our abstract model on database theory,
%where the notions of a database, a query, and a query answer are well-defined based on rigorous mathematical concepts;
%see, e.g., the standard introduction ... \todo{citation}.
%This framework is very general, well-established, and implemented in database management systems
%that scale well to large databases \todo{citation}.
%However, .....
%...
%We want to model individuals and concepts (e.g., ...) as well as relationships
%between individuals (e.g., ...).  $\leadsto$ constants, unary and binary relations
%...
%With the choice of graphs, we commit ourselves to a restricted view of a data source:
%graphs can only represent unary and binary relations via nodes and edges
%while, in general, a database may have relations of arbitrary arity.
%However, we do not consider this a significant restriction in the context of our purpose
%because we only want to represent relations that are relevant for provenance research,
%and those are predominantly unary or binary. \todo{strengthen argument, give examples, consult literature}
%
%%
%\begin{itemize}
%  \item
%    mathematically complex
%  \item
%    hard to visualise
%  \item
%    relations of arity $\geqslant 2$ seem overkill, given the relations used in OPACs, GND, Wikidata
%\end{itemize}
%%
%\todo[inline]{We first need an analysis of available data sources and of requirements; only then can we justify the choice of framework.}


% -------------------------------------------------------------------
\section{Labelled Directed Graphs}
\label{sec:labelled_digraphs}

In a nutshell, a labelled directed graph consists of a set of nodes, a set of directed edges between
the nodes, a function that names nodes with individuals,
and a function that labels the nodes (edges) with concepts (relations)
of which the nodes (edges) are instances.
In our setting, these four abstract components have the following meaning:
%
\begin{itemize}
  \item 
    Nodes represent entities such as works, expressions, manifestations, items,
    persons, or corporate bodies.
  \item 
    Edges represent relationships between nodes, which are typically directed:
    e.g., \term{has\_owner} points \emph{from} an item
    \emph{to} a person or corporate body,
    whereas \term{is\_owner\_of} points into the opposite direction.
    Symmetric relationships, such as \term{collaborates\_with},
    can be represented via two edges, one for each direction.
  \item 
    The unique node name specifies the individual that is represented by the node.
  \item 
    Node labels allow the specification of one or several concepts
    of which the respective node is an instance.
    For example, a node representing the physicist Albert Einstein
    may be labelled, among others, with the concepts \term{Person}, \term{Scientist},
    and \term{Physicist}.
%  \item 

    Edge labels allow the specification of one or several relation names for each edge.
    For example, if a person $p_1$ has a student $p_2$ and, in later life, 
    collaborates with $p_2$, then this can be represented via an edge from $p_1$ to $p_2$
    with the label $\{\term{has\_student},\term{collaborates\_with}\}$
    (and/or an edge from $b$ to $p$ with the label $\{\term{is\_student\_of},\term{collaborates\_with}\}$).
\end{itemize}
%
A labelled directed graph can be visualised in the obvious way:
each node is represented using a circle or rectangle
enclosing the node's name,
and each edge is denoted by an arrow.
Node and edge labels are written next to the respective node or edge;
multiple labels of the same node or edge are delimited with commas.
An example is given in Figure~\ref{fig:example_graph},
which represents a part of the data described in Chapter~\ref{chap:prototype_queries}
concerning an exemplar of Copernicus' \emph{De revolutionibus} at the
Gotha Research Library \emph{(FB Gotha)}.
For the sake of simplicity, the example graph deviates from the FRBR model
by omitting the FRBR entities \enquote{Expression} and \enquote{Manifestation}
between the nodes labelled \enquote{Work} and \enquote{Item}.

\newcommand{\tikzexagraph}[1][]{%
  \node [#1]                                (work1)   {\fns\mystrut\term{De revolutionibus}};
  \node [below=21mm of work1]               (item1)   {\fns\tikztabtwo{\term{FB Gotha}}{\term{Druck~4Â°~00466}}};
  \node [above right=4mm and 50mm of work1] (person1) {\fns\tikztabtwo{\term{Nicolaus}}{\term{Copernicus}}};
  \node [above right=9.5mm and 50mm of item1] (person2) {\fns\tikztabtwo{\term{Johann}}{\term{Hommel}}};
  \node [below right=9.5mm and 50mm of item1] (person3) {\fns\tikztabtwo{\term{Valentin}}{\term{Thau}}};
  
  \begin{scope}[%
    every node/.style={draw=none,fill=none,inner sep=.2mm}
  ]
    \path[->]
      (work1)   edge[bend right=10] node[pos=.4,left=1mm]      {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (item1)
      (item1)   edge[bend right=10] node[pos=.8,right=1mm]     {\fns\term{is\_exemplar\_of}}      (work1)
      (work1)   edge[bend left=4]   node[pos=.5,sloped, above] {\fns\strut\term{has\_creator}}    (person1)
      (person1) edge[bend left=4]   node[pos=.5,sloped, below] {\fns\strut\term{is\_creator\_of}} (work1)
      (item1)   edge[bend left=14]  node[pos=.5,sloped, above] {\fns\strut\term{has\_owner}}      (person2)
      (person2) edge[bend right=6]  node[pos=.5,sloped, below] {\fns\strut\term{is\_owner\_of}}   (item1)
      (item1)   edge[bend right=6]  node[pos=.5,sloped, above] {\fns\strut\term{has\_owner}}      (person3)
      (person3) edge[bend left=14]  node[pos=.5,sloped, below] {\fns\strut\term{is\_owner\_of}}   (item1)
      (person2) edge[bend right=10] node[pos=.46,left=1mm]     {\fns\tikztabtwo[r]{\term{has\_student,}}{\term{collaborates\_with}}} (person3)
      (person3) edge[bend right=10] node[pos=.54,right=1mm]    {\fns\tikztabtwo{\term{is\_student\_of,}}{\term{collaborates\_with}}} (person2)
    ;
      
    \node[above=.5mm of work1]   () {\fns\term{Work}};
    \node[below=.5mm of item1]   () {\fns\term{Item}};
    \node[right=.5mm of person1] () {\fns\tikztabtwo{\term{Person,}}{\term{Scientist}}};
    \node[right=.5mm of person2] () {\fns\tikztabtwo{\term{Person,}}{\term{Mathematician}}};
    \node[right=.5mm of person3] () {\fns\tikztabtwo{\term{Person,}}{\term{Astronomer}}};
    
  \end{scope}      
}
%
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexagraph
  \end{tikzpicture}
  
  \caption{An example graph}
  \label{fig:example_graph}
\end{figure}

As we will see in the following, labelled directed graphs can be used in our setting
to represent (combinations of) data sources as well as queries.
They allow us to draw on standard notions from graph theory and query answering
in order to define admissible query answers and to devise methods for obtaining those.

These considerations lead to the following definition of a labelled directed graph.

%\begin{definition}
%  Let $R$ be a set of \emph{relation names}.
%  A \emph{directed edge-labelled graph over $R$} is a triple $G = (V,E,\Lmc)$,
%  where
%  %
%  \begin{itemize}
%    \item
%    $V$ is a set, whose members are called or \emph{nodes};\footnote{%
%      In classical graph theory, nodes are called \emph{vertices}; thus the set of
%      nodes of a graph is denoted by $V$. We adopt the denotation $V$ for conformity
%      and the more modern term \enquote{node} for brevity.%
%    }      
%    \item 
%    $E \subseteq V \times V$ is a set of pairs of nodes, whose members are called \emph{edges};
%    \item
%    $\Lmc : E \to 2^R$ is a function that assigns to each edge a non-empty set of relation names,
%    called the \emph{labels} of that edge; we call \Lmc a \emph{labelling function}.
%  \end{itemize}
%\end{definition}
%
\begin{definition}
  \label{def:ld_graph}
  Let $\namespace=(\NI,\NC,\NR)$ be a \emph{namespace} consisting of a set \NI of \emph{individual names}, a set \NC of \emph{concept names}, and a set \NR of \emph{relation names}.
  A \emph{labelled directed graph over $\namespace$} is a triple $G = (V,E,\Nmc,\Lmc)$
  where
  %
  \begin{itemize}
    \item
      $V$ is a set, whose members are called \emph{nodes};\footnote{%
        In classical graph theory, nodes are called \emph{vertices}; thus the set of
        nodes of a graph is denoted by $V$. We adopt the denotation $V$ for conformity
        and the more modern term \enquote{node} for brevity.%
      }      
    \item 
      $E \subseteq V \times V$ is a set of pairs of nodes, whose members are called \emph{edges};
    \item
      $\Nmc : V \to \NI$ is an injective function that assigns
      to each node a unique individual (called the node's \emph{name});
    \item
      $\Lmc : V \cup E \to \NV \cup 2^{\NR}$ is a function that assigns 
      to each node a set of concept names (called the node's \emph{labels}) and
      to each edge a non-empty set of relation names (called the edge's \emph{labels});
      we call \Lmc a \emph{labelling function}.
  \end{itemize}
\end{definition}
%
Definition~1 stipulates the following conditions.
%%
%\begin{itemize}
%  \item
%    every node has a unique name and no two nodes have the same name (the latter being ensured by injectivity);
%  \item
%    a node can have an arbitrary number of labels, including no label (in case the node belongs to no concept);
%  \item
%    an edge can have an arbitrary number of labels, but that number must not be zero --
%    the effect of an edge having no labels can be achieved by simply omitting the edge.
%\end{itemize}
%
(1) Every node has a unique name, and no two nodes have the same name (the latter being ensured by injectivity).
(2) A node can have an arbitrary number of labels, including no label (in case the node belongs to no concept).
(3) An edge can have an arbitrary number of labels, but that number must not be zero --
the effect of an edge having no labels can be achieved by simply omitting that edge.

In the example in Figure~\ref{fig:example_graph},
$V$ consists of five nodes, which we call $v_1,\dots,v_5$,
and $E$ consists of ten edges. Let $v_1,v_2$ denote the nodes on the left and $v_3,v_4,v_5$
denote the nodes on the right (both from top to bottom).
Then we have, among others, the following node names and labels:
%
\begin{equation*}
  \Nmc(v_1) = \term{work}_1
  \qquad
  \Lmc(v_1) = \{\term{Work}\}
  \qquad
  \Lmc(v_5) = \{\term{Person},\term{Astronomer}\}
\end{equation*}
%
Additionally, two of the ten edges have the following labels:
%
\begin{alignat*}{2}
  e_1 & = (v_4,v_5) & \qquad \Lmc(e_1) & = \{\term{has\_student},\term{collaborates\_with}\} \\
  e_2 & = (v_5,v_4) &        \Lmc(e_2) & = \{\term{is\_student\_of},\term{collaborates\_with}\} \\
\end{alignat*}

% ------------------------------------------------------------------
\section{Modelling Data Sources, Queries, and Answers}
\label{sec:modelling}

We now model a data source (e.g., library catalogue, authority file, or other database)
using the exact notion of a graph that we have introduced above.
%
\begin{definition}
  \scalebox{0.973}[1]{A \emph{data source over the namespace $\namespace=(\NI,\NC,\NR)$} is a labelled directed graph
  over \namespace.}
\end{definition}
%
%With this definition, we obviously commit ourselves to a restricted view of a data source:
%graphs can only represent unary and binary relations via nodes and edges
%while, in general, a database may have relations of arbitrary arity.
%However, we do not consider this a significant restriction in the context of our purpose
%because we only want to represent relations that are relevant for provenance research,
%and those are predominantly unary or binary. \todo{strengthen argument, give examples, consult literature}
%
In order to model queries with the same notion of graphs, we need to introduce
two sets of variables that serve as distinct node names:
For example, consider the following variant of the example query \exaquery{2} from Chapter~\ref{chap:prototype_queries}:
%
\begin{enumerate}
  \item[\exaquery{2$'$}]
%    Which exemplars of work $W$ were passed from one of its owners to a collaborator of theirs?
    Which exemplars of \emph{De revolutionibus} were owned by some scientist who passed them on to a student?
\end{enumerate}
%
Query~\exaquery{2$'$}
should be modelled by the graph shown in Figure~\ref{fig:graph_for_exa_query2'}.

\newcommand{\tikzexaquery}{%
  \node                                        (derev) {\fns\mystrut$\term{De revolutionibus}$};
  \node [ansvar,below=14mm of work1]           (x)     {\fns\mystrut$x$};
  \node [anovar,above right=6.4mm and 24mm of x] (y)     {\fns\mystrut$y$};
  \node [anovar,below right=6.4mm and 24mm of x] (z)     {\fns\mystrut$z$};
  
  \begin{scope}[%
    every node/.style={draw=none,fill=none,inner sep=.2mm}
  ]
    \path[->]
      (derev) edge node[left=1mm]           {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
      (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
      (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
      (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
    ;
      
    \node[above=.5mm of derev] () {\fns\term{Work}};
    \node[left=.5mm of x]      () {\fns\term{Item}};
    \node[above=.5mm of y]     () {\fns\term{Scientist}};
    
  \end{scope}
}
%
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexaquery
  \end{tikzpicture}
  
  \caption{A graph representing example query \exaquery{2$'$}}
  \label{fig:graph_for_exa_query2'}
\end{figure}

The nodes of this graph fall into three groups:
%
\begin{enumerate}[(1)]
  \item
    the node named \tikzinlinenode{\term{De revolutionibus}} represents that work;
  \item
    node \tikzinlinenode[ansvar]{\mystrut$x$} represents an exemplar of this work that satisfies the conditions stated in~\exaquery{2$'$}
    and whose name is to be found;
  \item
    nodes \tikzinlinenode[anovar]{\mystrut$y$} and \tikzinlinenode[anovar]{\mystrut$z$}
    represent the two owners (scientist and their student) whose names are not known.
\end{enumerate}
%
Consequently, node name $x$ serves as a placeholder for the answer to the query,
and names $y,z$ are placeholders for further individuals that \enquote{witness} the answer.
We call $x$ the \emph{answer variable} and $y,z$ the \emph{anonymous variables}
of the query.

From now on, we fix two sets \VARANS and \VARANON
of \emph{answer variables} and \emph{anonymous variables}, respectively,
and we require that these two sets are disjoint with each other
and with any set \NI of individual names.
In particular, the namespace of data sources must not contain any variables,
in contrast to the namespace of queries.
These considerations lead to the following definition of a query.

\begin{definition}
  A \emph{query over the namespace $(\NI,\NC,\NR)$} is a labelled directed graph
  over $(\NI \uplus \VARANS \uplus \VARANON, \NC, \NR)$.
\end{definition}
%
\todo[inline,caption={}]{%
  Possibly comment on:
  %
  \begin{itemize}
    \item
      the special case of Boolean queries?
    \item
      specific requirements for modelling \exaquery{1} and \exaquery{3}: 
      \begin{itemize}
        \item 
          \exaquery{1} seems to require answer variables representing sets (the owners)
          and an appropriate extension of the definition of a homomorphism;
        \item 
          the same holds for \exaquery{3}; additionally the answer should include the relationships
          between the images of the answer variables (the relationships between the owners),
          i.e., some sort of spanned subgraph
      \end{itemize}
  \end{itemize}
}
%
Answers to queries will be defined via homomorphisms that map graphs representing queries
to graphs representing data sources.
%
\begin{definition}
  Let $\namespace=(\NI,\NC,\NR)$ be a namespace, $G = (V,E,\Nmc,\Lmc)$ a query over \namespace,
  and $G' = (V',E',\Nmc',\Lmc')$ a data source over \namespace.
  A \emph{homomorphism from $G$ to $G'$} is a map $h : V \to V'$ that satisfies the following properties.
  %
  \begin{enumerate}
    \item[\hmph{1}]
      $\Nmc(v) = \Nmc'(h(v))$ for every node $v \in V$ with $\Nmc(v) \in \NI$.
    \item[\hmph{2}]
      $\Lmc(v) \subseteq \Lmc'(h(v))$ for every node $v \in V$.
    \item[\hmph{3}]
      $\Lmc(v_1, v_2) \subseteq \Lmc'(h(v_1), h(v_2))$
      for every edge $(v_1,v_2) \in E$.
  \end{enumerate}
  %
  If $h$ is a homomorphism from $G$ to $G'$, we write $h : G \to G'$.
  If there is some homomorphism from $G$ to $G'$, we write $G \lesssim G'$.
\end{definition}
%
Property~\hmph{1} ensures that a homomorphism maps each node in $G$ that is named with an individual
to that node in $G'$ which is named with the same individual.
Nodes named with variables in $G$ can be mapped to arbitrary nodes in $G'$.
Properties~\hmph{2} and~\hmph{3} ensure that homomorphisms preserve node and edge labels;
the $\subseteq$-relation allows the image of a node (or edge) under $h$ to have more labels
than the node (or edge) itself.

Figure~\ref{fig:example_hmph} shows a homomorphism $h$ (dashed lines)
from the query depicted in Figure~\ref{fig:graph_for_exa_query2'}
to the graph from Figure~\ref{fig:example_graph}.

\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexaquery
    \tikzexagraph[right=64mm of derev]
    
    \begin{scope}[%
      every node/.style={draw=none,fill=none,inner sep=.2mm},
      every edge/.style={densely dashed,draw=black!70,thick}
    ]
      \path[->]
        (derev) edge[out= 20,in=160]               node[below=.6mm]         {\fns$h$} (work1)
        (x)     edge[out=270,in=200]               node[above=.4mm]         {\fns$h$} (item1)
        (y)     edge[out= 30,in=150,looseness=.19] node[above=.4mm,pos=.25] {\fns$h$} (person2)
        (z)     edge[out=340,in=200,looseness=.8]  node[above=.4mm,pos=.60] {\fns$h$} (person3)
      ;
      
    \end{scope}
  \end{tikzpicture}
  
  \caption{An example homomorphism}
  \label{fig:example_hmph}
\end{figure}

% ------------------------------------------------------------------
\section{Decision Problems}
\label{sec:decision_problems}

\todo[inline]{TODO: formulate problems, discuss (data!) complexity}

% ------------------------------------------------------------------
\section{Possible Extensions}
\label{sec:possible_extensions}

\todo[inline]{TODO; discuss more options? E.g., relations of arbitrary arity, data provenance, concrete values (\enquote{year of publication})}

\subsection*{Attributes on Relationships}

\begin{itemize}
  \item
    sketch idea: e.g., add year to relationship \term{has\_owner} -- example: \enquote{passed on to} requires descending year numbers \emph{and} no successor with intermediate year number
  \item
    explain difficulties: more complex formal machinery (def.\ of graphs, queries, and matches)
  \item
    argue for limited use: with or without the use of additional attributes, results may contain false positives due to incomplete data $\leadsto$ manual inspection is necessary anyway
  \item
    conclusion: attributes are not covered here
\end{itemize}

