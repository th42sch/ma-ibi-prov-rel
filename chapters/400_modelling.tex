% !TeX spellcheck = en_GB
% =================================================================
\chapter{A General Model of Provenance Relationships}
\label{chap:modelling}

In this chapter, we develop a generic approach to modelling provenance relationships.
More precisely, we need to model three central notions: queries that a user may want to ask,
data sources that are to be consulted in order to answer a query,
and answers given to a query.
In order to obtain a generic approach, we aim at providing rigorous definitions
for these central concepts, and we seek intensional rather than extensional definitions.
In particular, those definitions should not depend on concrete example queries or data sources
such as the ones discussed in Chapters~\ref{chap:prototype_queries} and~\ref{chap:analysis};
neither should they depend on concrete objects, concepts, or relationships
(such as \enquote{Copernicus}, \enquote{exemplar}, or \enquote{student}).
Instead, we will develop an abstract model that formalises
the notions of a query, data source, and answer.
This model can then be instantiated with a multitude of concrete queries and data sources,
and it specifies how future implementations need to proceed in order to
provide answers.

As a basis for our abstract model, we choose standard concepts and techniques
from graph theory.
The concept of a graph is widely used in computer science and discrete mathematics;
see standard textbooks \autocite[e.g.,][]{Diestel2012}.
Graphs and graph techniques are widely applied in various areas such as 
computer science, linguistics, physics and chemistry,
social sciences, and biology \autocite{WikiGraphTheoryApplications}.
In particular,\todo{also refer to SNA \autocite{Galety2022}}
they are used to represent large knowledge bases \autocite[e.g.,][]{Ehrlinger2016}
and underlie the Resource Description Framework (RDF) \autocite{W3CRDF}, which is a standard of the
World Wide Web Consortium (W3C) \autocite{W3C}.
Furthermore, the basic definition of a graph is conceptually simple,
and graph theory provides a plethora of well-understood concepts
and algorithms. By utilising graph theory, our application scenario
can benefit from these concepts, algorithms \autocite{Diestel2012,Even2012},
and implementations \autocite{PythonGraphLibraries,JGraphT}.

\todo[inline]{Delineate from classical database theory (text snippets commented out)? This argument should be a logical consequence of the requirement analysis in the previous chapter(s)!}


\todo[inline]{Explain \enquote{provenance} of the main ideas and provide references, as in email to Christian Rüter:}

\begin{quote}
  Die Idee mit den Übereinstimmungen ist nicht neu, sondern kommt im Wesentlichen aus der Beantwortung konjunktiver Anfragen aus dem Datenbank- und Ontologie\-bereich. Da jedoch Relationen in allgemeinen Datenbanken nicht nur unär oder binär sind, sondern beliebige Stelligkeit haben können, ist die Veranschaulichung als Graph nicht geeignet (es gibt Hypergraphen, aber kann man nicht übersichtlich zeichnen). Aber die wesentliche Idee des Homomorphismus und des „Wiederfindens“ der kleinen Struktur in der großen ist dieselbe. Und ich habe starke Anhaltspunkte dafür, dass die Relationen, auf die es in diesem Kontext ankommt und die auch in den Datenrepositorien abgebildet sind, überwiegend unär und binär sind.
\end{quote}

%An obvious choice would be to base our abstract model on database theory,
%where the notions of a database, a query, and a query answer are well-defined based on rigorous mathematical concepts;
%see, e.g., the standard introduction ... \todo{citation}.
%This framework is very general, well-established, and implemented in database management systems
%that scale well to large databases \todo{citation}.
%However, .....
%...
%We want to model objects and concepts (e.g., ...) as well as relationships
%between objects (e.g., ...).  $\leadsto$ constants, unary and binary relations
%...
%With the choice of graphs, we commit ourselves to a restricted view of a data source:
%graphs can only represent unary and binary relations via nodes and edges
%while, in general, a database may have relations of arbitrary arity.
%However, we do not consider this a significant restriction in the context of our purpose
%because we only want to represent relations that are relevant for provenance research,
%and those are predominantly unary or binary. \todo{strengthen argument, give examples, consult literature}
%
%%
%\begin{itemize}
%  \item
%    mathematically complex
%  \item
%    hard to visualise
%  \item
%    relations of arity $\geqslant 2$ seem overkill, given the relations used in OPACs, GND, Wikidata
%\end{itemize}
%%
%\todo[inline]{We first need an analysis of available data sources and of requirements; only then can we justify the choice of framework.}

In the following sections, we introduce our model
by defining the underlying notion of a graph and the abstract notions of data sources, queries, and answers
(Sections~\ref{sec:labelled_digraphs} and~\ref{sec:modelling}).
We also discuss decision procedures related to query answering in Section~\ref{sec:decision_problems}.
Up to that point, the model remains very basic, which is a deliberate choice
in order to make it conceptually comprehensible.
In particular, although
the definitions are elementary and self-contained from a mathematical point of view,
we provide additional explanations and illustrations for the sake of readers with little or no background in
mathematics.
In order to obtain a more flexible and comprehensive model, we discuss our modelling decisions
in Section~\ref{sec:modelling_discussion} and possible extensions in Section~\ref{sec:possible_extensions}.

% -------------------------------------------------------------------
\section{Labelled Directed Graphs}
\label{sec:labelled_digraphs}

%\begin{figure}[ht]
\begin{wrapfigure}[6]{o}{5.2cm}
  \centering
  \vspace*{-.7\baselineskip}
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,circle,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \node                       (nw)                         {};
    \node [right=12mm of nw]    (ne)                         {};
    \node [below= 8mm of nw]    (sw)                         {};
    \node [right=12mm of sw]    (se)                         {};
    \node [draw=none,fill=none] (n)     at ($(nw)!0.5!(ne)$) {};
    \node [above= 6mm of n]     (ridge)                      {};
      
    \path[->]
      (sw)    edge (nw)
      (nw)    edge (ridge)
      (ridge) edge (ne)
      (ne)    edge (se)
      (se)    edge (sw)
      (sw)    edge (ne)
      (ne)    edge (nw)
      (nw)    edge (se)
    ;
        
  \end{tikzpicture}
  \caption{A directed graph}
  \label{fig:example_graph_abstract}
%\end{figure}
\end{wrapfigure}

The basic components of a graph are nodes and edges. Edges link nodes, and they can be directed
or undirected. Graphs are easy to visualise; nodes are typically represented as circles
or rectangles, and edges as arrows (directed) or lines (undirected).
Figure~\ref{fig:example_graph_abstract} gives an abstract example of a directed graph.

For our purposes,
nodes represent objects or literals. Objects include, e.g., works, expressions, manifestations, items,
persons, or corporate bodies; literals include, e.g., publication years, birth years, or identifiers.
Edges represent relationships between those objects or literals, and those relationships are typically directed:
e.g., \term{has\_owner} points \emph{from} an item
\emph{to} a person or corporate body,
whereas \term{is\_owner\_of} points into the opposite direction.
Therefore we use \emph{directed} graphs.
Symmetric relationships, such as \term{collaborates\_with},
can be represented via two edges in both directions.

Furthermore, we want to assign a unique name to each node of a graph
and one or several labels to each node and each edge:
The name of a node specifies the \emph{object} that is represented by that node.
The labels of a node specify the \emph{concepts}
of which that node is an \emph{instance}.
For example, a node representing the physicist Albert Einstein
may be labelled, among others, with the concepts \term{Person}, \term{Scientist},
and \term{Physicist}.
The labels of an edge specify the \emph{relations} of which the pair of nodes
represented by that edge is an instance.
For example, if a person $p_1$ has a student $p_2$ and, in later life, 
collaborates with $p_2$, then this can be represented via an edge from $p_1$ to $p_2$
with the label $\{\term{has\_student},\term{collaborates\_with}\}$
(and/or an edge from $b$ to $p$ with the label $\{\term{is\_student\_of},\term{collaborates\_with}\}$).
These considerations lead us to a straightforward extension
of the notion of a directed graph:
a \emph{labelled directed graph}.

\todo[inline]{Refer to the literature for labelled graphs? Refer to description logic terminology regarding the terms \enquote{object}, \enquote{concept}, \enquote{relation}, \emph{instance}, etc.? Distinguish clearly between \enquote{relation} and \enquote{relationship}.}

In order to visualise a labelled directed graph,
node names are written into the respective node,
and node and edge labels are written next to the node or edge.
Multiple labels of the same node or edge are delimited with commas.
An example is given in Figure~\ref{fig:example_graph}.
The shown graph represents a part of the data described in Section~\ref{sec:manual_answering}
concerning an exemplar of Copernicus' \emph{De revolutionibus} at the
Gotha Research Library \emph{(FB Gotha)}.
It contains a node for the work (labelled with the FRBR entity \term{Work}),
a node for the exemplar (labelled with the FRBR entity \term{Item}),
and nodes for the author and two of the owners (labelled with their professions according to their GND entries).
For the sake of this example, the owners are additionally labelled with the profession
\term{Scientist}, which is implicit in the real data.
The ten edges represent the FRBR relationships between work and item,
the creator relationship between work and author,
the owner relationship between exemplar and two owners,
student and collaboration relationships between the owners,
and the converses of these relationships.
For the sake of simplicity, the graph deviates from the FRBR model \autocite{FRBR1998}
by omitting the FRBR entities \enquote{Expression} and \enquote{Manifestation}
that should occur between the nodes labelled \enquote{Work} and \enquote{Item}.

\newcommand{\tikzexagraph}[1][]{%
  \node [#1]                                (work1)   {\fns\mystrut\term{De\_revolutionibus}};
  \node [below=21mm of work1]               (item1)   {\fns\tikztabtwo{\term{FB\_Gotha\_}}{\term{Druck\_4°\_00466}}};
  \node [above right=4mm and 50mm of work1] (person1) {\fns\tikztabtwo{\term{Nicolaus\_}}{\term{Copernicus}}};
  \node [above right=9.5mm and 50mm of item1] (person2) {\fns\tikztabtwo{\term{Johann\_}}{\term{Hommel}}};
  \node [below right=9.5mm and 50mm of item1] (person3) {\fns\tikztabtwo{\term{Valentin\_}}{\term{Thau}}};
  
  \begin{scope}[%
    every node/.style={draw=none,fill=none,inner sep=.2mm}
  ]
    \path[->]
      (work1)   edge[bend right=10] node[pos=.4,left=1mm]      {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (item1)
      (item1)   edge[bend right=10] node[pos=.8,right=1mm]     {\fns\term{is\_exemplar\_of}}      (work1)
      (work1)   edge[bend left=4]   node[pos=.5,sloped, above] {\fns\strut\term{has\_creator}}    (person1)
      (person1) edge[bend left=4]   node[pos=.5,sloped, below] {\fns\strut\term{is\_creator\_of}} (work1)
      (item1)   edge[bend left=14]  node[pos=.5,sloped, above] {\fns\strut\term{has\_owner}}      (person2)
      (person2) edge[bend right=6]  node[pos=.5,sloped, below] {\fns\strut\term{is\_owner\_of}}   (item1)
      (item1)   edge[bend right=6]  node[pos=.5,sloped, above] {\fns\strut\term{has\_owner}}      (person3)
      (person3) edge[bend left=14]  node[pos=.5,sloped, below] {\fns\strut\term{is\_owner\_of}}   (item1)
      (person2) edge[bend right=10] node[pos=.46,left=1mm]     {\fns\tikztabtwo[r]{\term{has\_student,}}{\term{collaborates\_with}}} (person3)
      (person3) edge[bend right=10] node[pos=.54,right=1mm]    {\fns\tikztabtwo{\term{is\_student\_of,}}{\term{collaborates\_with}}} (person2)
    ;
      
    \node[above=.5mm of work1]   () {\fns\term{Work}};
    \node[below=.5mm of item1]   () {\fns\term{Item}};
    \node[right=.5mm of person1] () {\fns\tikztabtwo{\term{Person,}}{\term{Astronomer}}};
    \node[right=.5mm of person2] () {\fns\tikztabthree{\term{Person,}}{\term{Scientist,}}{\term{Mathematician}}};
    \node[right=.5mm of person3] () {\fns\tikztabthree{\term{Person,}}{\term{Scientist,}}{\term{Astronomer}}};
    
  \end{scope}      
}
%
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexagraph
  \end{tikzpicture}
  
  \caption{A labelled directed graph that represents data
    concerning an exemplar of Copernicus' \emph{De revolutionibus} and some of its owners}
  \label{fig:example_graph}
\end{figure}

As we will see in the following, labelled directed graphs can be used in our setting
to represent (combinations of) data sources as well as queries.
They allow us to draw on standard notions from graph theory and query answering
in order to define admissible query answers and to devise methods for obtaining those.

%In a nutshell, a labelled directed graph consists of a set of nodes, a set of directed edges between
%the nodes, a function that names nodes with objects,
%and a function that labels the nodes (edges) with concepts (relations)
%of which the nodes (edges) are instances.
%In our setting, these four abstract components have the following meaning:

The above explanations can be cast into a rigorous mathematical definition,
which uses sets to represent nodes, a binary relation over the set of nodes
to represent edges, and functions over the nodes and edges to represent
names and labels. In order for the range of those functions to be well-defined,
the definition of a labelled directed graph is relative to a namespace which
contains all the names of objects, concepts and relations that are relevant.
The contents of this namespace is arbitrary and may consist,
for example, of all the names found in the relevant data sources.
The following definition introduces the notions of a namespace and a
labelled directed graph.
%
%\begin{definition}
%  Let $R$ be a set of \emph{relation names}.
%  A \emph{directed edge-labelled graph over $R$} is a triple $G = (V,E,\Lmc)$,
%  where
%  %
%  \begin{itemize}
%    \item
%    $V$ is a set, whose members are called or \emph{nodes};\footnote{%
%      In classical graph theory, nodes are called \emph{vertices}; thus the set of
%      nodes of a graph is denoted by $V$. We adopt the denotation $V$ for conformity
%      and the more modern term \enquote{node} for brevity.%
%    }      
%    \item 
%    $E \subseteq V \times V$ is a set of pairs of nodes, whose members are called \emph{edges};
%    \item
%    $\Lmc : E \to 2^R$ is a function that assigns to each edge a non-empty set of relation names,
%    called the \emph{labels} of that edge; we call \Lmc a \emph{labelling function}.
%  \end{itemize}
%\end{definition}
%
\begin{definition}
  \label{def:ld_graph}
  Let $\namespace=(\NO,\NC,\NR)$ be a \emph{namespace} consisting of a set \NO of \emph{object names}, a set \NC of \emph{concept names}, and a set \NR of \emph{relation names}.
  A \emph{labelled directed graph over $\namespace$} is a triple $G = (V,E,\Nmc,\Lmc)$
  where
  %
  \begin{itemize}
    \item
      $V$ is a set, whose members are called \emph{nodes};\footnote{%
        In classical graph theory, nodes are called \emph{vertices}; thus the set of
        nodes of a graph is denoted by $V$. We adopt the denotation $V$ for conformity
        and the more modern term \enquote{node} for brevity.%
      }      
    \item 
      $E \subseteq V \times V$ is a set of pairs of nodes, whose members are called \emph{edges};
    \item
      $\Nmc : V \to \NO$ is an injective function that assigns
      to each node a unique object (called the node's \emph{name});
    \item
      $\Lmc : V \cup E \to \NV \cup 2^{\NR}$ is a function that assigns 
      to each node a set of concept names (called the node's \emph{labels}) and
      to each edge a non-empty set of relation names (called the edge's \emph{labels});
      we call \Lmc a \emph{labelling function}.
  \end{itemize}
\end{definition}
%
Definition~1 formalises the following commitments regarding names and labels.
%%
%\begin{itemize}
%  \item
%    every node has a unique name and no two nodes have the same name (the latter being ensured by injectivity);
%  \item
%    a node can have an arbitrary number of labels, including no label (in case the node belongs to no concept);
%  \item
%    an edge can have an arbitrary number of labels, but that number must not be zero --
%    the effect of an edge having no labels can be achieved by simply omitting the edge.
%\end{itemize}
%
(1) Every node has a unique name, and no two nodes have the same name (the latter being ensured by injectivity).
(2) A node can have an arbitrary number of labels, including no label (in case the node belongs to no concept).
(3) An edge can have an arbitrary number of labels, but that number must not be zero --
the effect of an edge having no labels can be achieved by simply omitting that edge.

In order to illustrate the components of Definition~\ref{def:ld_graph},
we refer to the graph depicted in Figure~\ref{fig:example_graph}:
$V$ consists of five nodes, and $E$ of ten edges
(each single arrow constitutes an edge since the direction matters).
%Let $v_1,v_2$ denote the nodes on the left and $v_3,v_4,v_5$
%denote the nodes on the right (both from top to bottom).
There are, among others, the following node names and labels:
%
\begin{itemize}
  \item
    The node at the top left has the name \term{De\_revolutionibus}
    and the single label \term{Work}.
  \item 
    The node at the bottom right has the two labels \term{Person} and \term{Astronomer}.
  \item 
    The edge from the node named \term{Johann\_Hommel} to the node named \term{Valentin\_Thau}
    has the two labels \term{has\_student} and \term{collaborates\_with},
    and the edge pointing into the converse direction has the labels
    \term{is\_student\_of} and \term{collaborates\_with}.
\end{itemize}
%
%%
%\begin{equation*}
%  \Nmc(v_1) = \term{De\_revolutionibus}
%  \qquad
%  \Lmc(v_1) = \{\term{Work}\}
%  \qquad
%  \Lmc(v_5) = \{\term{Person},\term{Astronomer}\}
%\end{equation*}
%%
%Additionally, two of the ten edges have the following labels:
%%
%\begin{alignat*}{2}
%  e_1 & = (v_4,v_5) & \qquad \Lmc(e_1) & = \{\term{has\_student},\term{collaborates\_with}\} \\
%  e_2 & = (v_5,v_4) &        \Lmc(e_2) & = \{\term{is\_student\_of},\term{collaborates\_with}\} \\
%\end{alignat*}

% ------------------------------------------------------------------
\section{Modelling Data Sources, Queries, and Answers}
\label{sec:modelling}

We can now use our notion of a labelled directed graph to model
data sources and queries, and to obtain a rigorous definition of a query answer.

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
\subsection{Data Sources}

Data sources correspond exactly to our notion of a graph.
%
\begin{definition}
  \label{def:data_source}
  \scalebox{0.965}[1]{A \emph{data source over the namespace $\namespace=(\NO,\NC,\NR)$} is a labelled directed graph
  over \namespace.}
%  A \emph{data source over the namespace $\namespace=(\NO,\NC,\NR)$} is a labelled directed graph
%  over \namespace.
\end{definition}
%
In our model, we assume that there is always a \emph{single} data source against which a query is posed and evaluated.
When the model is applied to real-word queries and data sources,
the abstract notion of a data source is instantiated by the union of
all available concrete data sources (such as catalogues, authority files, knowledge bases),
including mappings between them if applicable.

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
\subsection{Queries}

In order to model queries based on the same notion of a graph, we need to distinguish
two special groups of nodes that act as placeholders (1) for the object(s) after which the query asks
and (2) for further objects that are mentioned in the query without being named explicitly.
For example, consider Query \exaquery{2$'$} from Section~\ref{sec:manual_answering}:
%
\begin{enumerate}
  \item[\exaquery{2$'$}]
%    Which exemplars of work $W$ were passed from one of its owners to a collaborator of theirs?
    Which exemplars of \emph{De revolutionibus} were owned by some scientist who passed them on to a student?
\end{enumerate}
%
To model this query, we do not only need a node representing the work \emph{De revolutionibus},
but also a node representing an exemplar that satisfies the conditions stated in the query and whose name is asked for (Group~1),
and two nodes representing the owner and their student (Group~2).
Since these three individuals are not known, we need to use \emph{variables} for naming them.
Query~\exaquery{2$'$}
can then be modelled by the graph shown in Figure~\ref{fig:graph_for_exa_query2'}.

\newcommand{\tikzexaquery}{%
  \node                                        (derev) {\fns\mystrut$\term{De\_revolutionibus}$};
  \node [ansvar,below=14mm of work1]           (x)     {\fns\mystrut$x$};
  \node [anovar,above right=6.4mm and 24mm of x] (y)     {\fns\mystrut$y$};
  \node [anovar,below right=6.4mm and 24mm of x] (z)     {\fns\mystrut$z$};
  
  \begin{scope}[%
    every node/.style={draw=none,fill=none,inner sep=.2mm}
  ]
    \path[->]
      (derev) edge node[left=1mm]           {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
      (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
      (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
      (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
    ;
      
    \node[above=.5mm of derev] () {\fns\term{Work}};
    \node[left=.5mm of x]      () {\fns\term{Item}};
    \node[above=.5mm of y]     () {\fns\term{Scientist}};
    
  \end{scope}
}
%
\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexaquery
  \end{tikzpicture}
  
  \caption{A graph representing example query \exaquery{2$'$}}
  \label{fig:graph_for_exa_query2'}
\end{figure}

The nodes of this graph fall into three groups:
%
\begin{enumerate}[(1)]
  \item
    The node named \tikzinlinenode{\term{De\_revolutionibus}} represents that work;
  \item
    Node \tikzinlinenode[ansvar]{\mystrut$x$} falls into Group~1 as explained above;
  \item
    Nodes \tikzinlinenode[anovar]{\mystrut$y$} and \tikzinlinenode[anovar]{\mystrut$z$}
    fall into Group~2 as explained above.
\end{enumerate}
%
Node names $x,y,z$ are the variables mentioned above,
and we call $x$ the \emph{answer variable} and $y,z$ the \emph{anonymous variables}
of this query.
From now on, we fix two sets \VARANS and \VARANON
of \emph{answer variables} and \emph{anonymous variables}, respectively,
and we assume that they both contain a countably infinite number of elements---%
which simply ensures that there is an unlimited supply of variables.
We furthermore require that these two sets are disjoint with each other
and with any set \NO of object names.
Thus, according to Definition~\ref{def:data_source},
graphs representing data sources cannot use any variables as node names.

In order to allow queries to use variables,
the following definition of a query is now immediate. 
%
\begin{definition}
  A \emph{query over the namespace $(\NO,\NC,\NR)$} is a labelled directed graph
  over $(\NO \uplus \VARANS \uplus \VARANON, \NC, \NR)$.
\end{definition}
%
The operator \enquote{$\uplus$} used in this definition
stands for \emph{disjoint union}, i.e., \enquote{$A \uplus B$}
stands for the union of the \emph{disjoint} sets $A,B$.
The wording of the definition also ensures
that we do not have to mention variables explicitly when specifying the
namespace of a query.

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
\subsection{Query Answers}

Based on the representation of both data sources and queries as graphs,
we can now define the notion of an answer to a query 
with respect to a data source. For this purpose, it is important to realise
that, typically, a query is a small graph and a data source is a large graph,
and that finding answers simply means finding small parts of the large graph
that have the same structure as the small graph.
For the example query given in Figure~\ref{fig:graph_for_exa_query2'},
this means that every subgraph of the data source consisting of four nodes
with the same edges and labels should be an answer.
Regarding the previous example, the subgraphs given in
Figure~\ref{fig:example_answers}~(a,\,b) constitute answers,
while the subgraphs in Figure~\ref{fig:example_answers}~(c,\,d) do not:
Subgraph~(a) is identical to the query graph with the only exception that it
contains proper objects instead of variables in the node names;
Subgraph~(b) is the same graph but extended with additional information;
Subgraph~(c) lacks the edge labelled \term{has\_student} between the two owners;
Subgraph~(d) resembles the structure of the query but does not contain
the required node named \term{De\_revolutionibus}.

\newlength{\student}
\settowidth{\student}{{\fns\term{student}}}
\newlength{\Scientist}
\settowidth{\Scientist}{{\fns\term{Scientist}}}
\begin{figure}[ht]
  \centering
  \begin{tabular}{@{}c@{\hspace{10mm}}c@{}}
    \begin{tikzpicture}[
      >=Latex,
      every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
      every edge/.style={draw=black,thick}
    ]
      \node                                   (derev) {\fns\mystrut$\term{De\_revolutionibus}$};
      \node [below=16mm of work1]             (x)     {\fns\tikztabtwo{\term{FB\_Gotha\_}}{\term{Druck\_4°\_00466}}};
      \node [above right=8.5mm and 37mm of x] (y)     {\fns\tikztabtwo{\term{Johann\_}}{\term{Hommel}}};
      \node [below right=8.5mm and 37mm of x] (z)     {\fns\tikztabtwo{\term{Valentin\_}}{\term{Thau}}};
  
      \begin{scope}[%
        every node/.style={draw=none,fill=none,inner sep=.2mm}
      ]
        \path[->]
          (derev) edge node[left=1mm]           {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
          (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
          (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
          (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
        ;
          
        \node[above=.5mm of derev] () {\fns\term{Work}};
        \node[below=.5mm of x]     () {\fns\term{Item}};
        \node[above=.5mm of y]     () {\fns\term{Scientist}};
      \end{scope}
    \end{tikzpicture}
    &
    \begin{tikzpicture}[
      >=Latex,
      every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
      every edge/.style={draw=black,thick}
    ]
      \node                                   (derev) {\fns\mystrut$\term{De\_revolutionibus}$};
      \node [below=16mm of work1]             (x)     {\fns\tikztabtwo{\term{FB\_Gotha\_}}{\term{Druck\_4°\_00466}}};
      \node [above right=8.5mm and 37mm of x] (y)     {\fns\tikztabtwo{\term{Johann\_}}{\term{Hommel}}};
      \node [below right=8.5mm and 37mm of x] (z)     {\fns\tikztabtwo{\term{Valentin\_}}{\term{Thau}}};
  
      \begin{scope}[%
        every node/.style={draw=none,fill=none,inner sep=.2mm}
      ]
        \path[->]
          (derev) edge[bend right=10] node[left=1mm]         {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
          (x)     edge[bend right=10] node[pos=.6,right=1mm] {\fns\term{is\_exemplar\_of}}                       (derev)
          (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
          (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
          (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
        ;
          
        \node[above=.5mm of derev] () {\fns\term{Work}};
        \node[below=.5mm of x]     () {\fns\term{Item}};
        \node[right=.5mm of y]     () {\fns\tikztabtwo{\term{Person}}{\term{Scientist}}};
        \node[right=.5mm of z]     () {\fns\tikztabtwo{\term{Person}}{\term{Scientist}}};
      \end{scope}
    \end{tikzpicture}
    \\[-6pt]
    (a) & (b) \\[6pt]
    \begin{tikzpicture}[
      >=Latex,
      every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
      every edge/.style={draw=black,thick}
    ]
      \node                                   (derev) {\fns\mystrut$\term{De\_revolutionibus}$};
      \node [below=16mm of work1]             (x)     {\fns\tikztabtwo{\term{FB\_Gotha\_}}{\term{Druck\_4°\_00466}}};
      \node [above right=8.5mm and 37mm of x] (y)     {\fns\tikztabtwo{\term{Johann\_}}{\term{Hommel}}};
      \node [below right=8.5mm and 37mm of x] (z)     {\fns\tikztabtwo{\term{Valentin\_}}{\term{Thau}}};
  
      \begin{scope}[%
        every node/.style={draw=none,fill=none,inner sep=.2mm}
      ]
        \path[->]
          (derev) edge node[left=1mm]           {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
          (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
          (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
%          (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
        ;
        \path[every edge/.style={draw=none}]
          (y) edge node[right=1mm] {\rule{\student}{0pt}} (z)
        ;

        \node[above=.5mm of derev] () {\fns\term{Work}};
        \node[below=.5mm of x]     () {\fns\term{Item}};
        \node[above=.5mm of y]     () {\fns\term{Scientist}};
      \end{scope}
    \end{tikzpicture}
    &
    \begin{tikzpicture}[
      >=Latex,
      every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
      every edge/.style={draw=black,thick}
    ]
      \node                                   (derev) {\fns\mystrut$\term{ABC}$};
      \node [below=16mm of work1]             (x)     {\fns\mystrut$\term{DEF}$};
      \node [above right=8.5mm and 37mm of x] (y)     {\fns\tikztabtwo{\term{Johann\_}}{\term{Hommel}}};
      \node [below right=8.5mm and 37mm of x] (z)     {\fns\tikztabtwo{\term{Valentin\_}}{\term{Thau}}};
  
      \begin{scope}[%
        every node/.style={draw=none,fill=none,inner sep=.2mm}
      ]
        \path[->]
          (derev) edge node[left=1mm]           {\fns\tikztabtwo[r]{\term{has\_}}{\term{exemplar}}} (x)
          (x)     edge node[sloped, above=.6mm] {\fns\term{has\_owner}}         (y)
          (x)     edge node[sloped, below]      {\fns\strut\term{has\_owner}}   (z)
          (y)     edge node[right=1mm]          {\fns\tikztabtwo[r]{\term{has\_}}{\term{student}}} (z)      
        ;
          
        \node[above=.5mm of derev] () {\fns\term{Work}};
        \node[below=.5mm of x]     () {\fns\term{Item}};
        \node[right=.5mm of y]     () {\fns\term{Scientist}};
      \end{scope}
    \end{tikzpicture}
    \\[-6pt]
    (c) & (d)
  \end{tabular}
  %
  \caption{Positive (a,\,b) and negative (c,\,d) examples for query answers}
  \label{fig:example_answers}
\end{figure}

In order to identify subgraphs of a given graph that have the same structure as another given graph,
we use the notion of a homomorphism.
A homomorphism is a function that maps some object to another
while preserving the structure of the former.
We therefore need to define a variant of homomorphisms that maps queries
to data sources. This variant is given in the following.
%
\begin{definition}
  Let $\namespace=(\NO,\NC,\NR)$ be a namespace, $G = (V,E,\Nmc,\Lmc)$ a query over \namespace,
  and $G' = (V',E',\Nmc',\Lmc')$ a data source over \namespace.
  A \emph{homomorphism from $G$ to $G'$} is a map $h : V \to V'$ that satisfies the following properties.
  %
  \begin{enumerate}
    \item[\hmph{1}]
      $\Nmc(v) = \Nmc'(h(v))$ for every node $v \in V$ with $\Nmc(v) \in \NO$.
    \item[\hmph{2}]
      $\Lmc(v) \subseteq \Lmc'(h(v))$ for every node $v \in V$.
    \item[\hmph{3}]
      $\Lmc(v_1, v_2) \subseteq \Lmc'(h(v_1), h(v_2))$
      for every edge $(v_1,v_2) \in E$.
  \end{enumerate}
  %
  If $h$ is a homomorphism from $G$ to $G'$, we write $h : G \to G'$.
  If there is some homomorphism from $G$ to $G'$, we write $G \lesssim G'$.
\end{definition}
%
Property~\hmph{1} requires that a homomorphism maps each node in $G$ that is named with an object
to that node in $G'$ which is named with the same object.
Nodes named with variables in $G$ can be mapped to arbitrary nodes in $G'$.
Properties~\hmph{2} and~\hmph{3} require that homomorphisms preserve node and edge labels;
more precisely, the image of a node (or edge) under $h$ must have \emph{at least}
the same labels (and may have additional labels).

Figure~\ref{fig:example_hmph} shows a homomorphism $h$ (dashed lines)
from the query depicted in Figure~\ref{fig:graph_for_exa_query2'}
to the graph from Figure~\ref{fig:example_graph}.

\begin{figure}[ht]
  \centering
  \begin{tikzpicture}[
    >=Latex,
    every node/.style={on grid,rectangle,rounded corners=1mm,draw=black,fill=lightblue,thick,inner sep=1.5mm},
    every edge/.style={draw=black,thick}
  ]
    \tikzexaquery
    \tikzexagraph[right=64mm of derev]
    
    \begin{scope}[%
      every node/.style={draw=none,fill=none,inner sep=.2mm},
      every edge/.style={densely dashed,draw=black!70,thick}
    ]
      \path[->]
        (derev) edge[out= 20,in=160]               node[below=.6mm]         {\fns$h$} (work1)
        (x)     edge[out=270,in=200]               node[above=.4mm]         {\fns$h$} (item1)
        (y)     edge[out= 30,in=150,looseness=.19] node[above=.4mm,pos=.25] {\fns$h$} (person2)
        (z)     edge[out=340,in=200,looseness=.8]  node[above=.4mm,pos=.60] {\fns$h$} (person3)
      ;
      
    \end{scope}
  \end{tikzpicture}
  
  \caption{An example homomorphism}
  \label{fig:example_hmph}
\end{figure}


% ------------------------------------------------------------------
\section{Decision Procedures}
\label{sec:decision_problems}
\label{sec:decision_procedures}

\todo[inline]{Formulate decision problem, discuss (data) complexity \& algorithms. (Reduction to FO/SQL?)}


% ------------------------------------------------------------------
\section{Discussion of the Modelling Decisions}
\label{sec:modelling_discussion}

\todo[inline]{Relate this \enquote{machinery} to the example queries. In particular:}
%
\begin{itemize}
  \item
    Comment on Boolean queries if necessary.
  \item
    Discuss specific requirements for modelling \exaquery{1} and \exaquery{3}: 
    %
    \begin{itemize}
      \item 
        \exaquery{1} seems to require answer variables representing sets (the owners)
        and an appropriate extension of the definition of a homomorphism;
      \item 
        the same holds for \exaquery{3}; additionally the answer should include the relationships
        between the images of the answer variables (the relationships between the owners),
        i.e., some sort of spanned subgraph
      \item[$\leadsto$]
        extensions needed; description or sketch of these and other extensions in the next section
    \end{itemize}
    %
\end{itemize}



% ------------------------------------------------------------------
\section{Possible Extensions}
\label{sec:possible_extensions}

\todo[inline]{TODO: Discuss further extensions:}
%
\begin{itemize}
  \item
    relations of arbitrary arity
  \item
    data provenance
  \item
    concrete values (\enquote{year of publication})
  \item
    attributes on relationships:
    %
    \begin{itemize}
      \item
        sketch idea: e.g., provide year for relationship \term{has\_owner} -- example: \enquote{passed on to} requires descending year numbers \emph{and} no successor with intermediate year number
      \item
        solution: quads instead of triples (in RDF speak); add attributes to the graph model? (Markus Krötzsch's work?)
      \item
        explain difficulties: more complex formal machinery (def.\ of graphs, queries, and matches); missing data, e.g.:
        %
        \begin{itemize}
          \item
            From which year \emph{to which year} did person $X$ own item $Y$?
          \item
            Was person $Z$ a student of person $X$'s \emph{at the point in time when $X$ passed the item on to $Z$}?
        \end{itemize}
      \item
        discuss usefulness: false positives due to incomplete data as discussed in Section~\ref{sec:quality_of_answers}
        $\leadsto$ manual inspection is necessary anyway; attributes may still help hide false answers
    \end{itemize}
    %
  \item
    Discuss SoNAR requirements R0xx:
    
    Some requirements can be addressed directly with our queries, e.g., R006! (R016?!?)

    R016 seems to require the \enquote{$\top$-role} in queries!

    Edge weights;

    E.g. R029, 30, 61: explorative (for every node/edge the available attributes) vs. ??? (ask query knowing those attributes)
    
\end{itemize}
